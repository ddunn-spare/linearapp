---
phase: 02-linear-internal-write-actions
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - apps/web/src/components/ApprovalCard.tsx
  - apps/web/src/pages/ChatPage.tsx
autonomous: false

must_haves:
  truths:
    - "Approval card shows issue identifier + title together (e.g., 'ENG-123: Fix login bug')"
    - "Create actions show essential fields upfront, other fields in collapsed/expandable section"
    - "Destructive actions (delete) have red/warning styling on the approval card"
    - "Bulk operation preview shows a table-like layout with each issue on its own row"
    - "Bulk operations above 10 issues show a visible warning in the card"
    - "Linear actions have a visually distinct color/icon from OKR actions"
    - "User can ask agent to create a Linear issue and see it appear in Linear after approval"
    - "User can ask agent to create/update OKRs through the approval flow"
  artifacts:
    - path: "apps/web/src/components/ApprovalCard.tsx"
      provides: "Enhanced approval card with destructive styling, expandable sections, bulk table, and category color-coding"
      contains: "destructive"
    - path: "apps/web/src/pages/ChatPage.tsx"
      provides: "ChatPage passes category to ApprovalCard"
      contains: "category"
  key_links:
    - from: "apps/web/src/components/ApprovalCard.tsx"
      to: "@linearapp/shared ActionProposal"
      via: "Reads proposal.category and proposal.preview for rendering decisions"
      pattern: "proposal\\.category"
    - from: "apps/web/src/components/ApprovalCard.tsx"
      to: "apps/server/src/tools/index.ts"
      via: "Tool metadata destructive flag drives card styling"
      pattern: "destructive"
---

<objective>
Enhance the ApprovalCard component with Linear-specific and OKR-specific rendering: destructive action warning styling, essential/expandable field sections for creates, bulk operation table preview, and category-based color differentiation. Then verify the full end-to-end flow.

Purpose: The approval card is the user's primary interaction surface for write actions. These enhancements make it clear what will change, warn about destructive operations, and visually distinguish action types -- all per user decisions.
Output: Enhanced ApprovalCard with rich, context-aware rendering for all Phase 2 write actions.
</objective>

<execution_context>
@/Users/devondunn/.claude/get-shit-done/workflows/execute-plan.md
@/Users/devondunn/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-linear-internal-write-actions/02-01-SUMMARY.md
@.planning/phases/02-linear-internal-write-actions/02-02-SUMMARY.md
@.planning/phases/02-linear-internal-write-actions/02-03-SUMMARY.md

@apps/web/src/components/ApprovalCard.tsx
@apps/web/src/pages/ChatPage.tsx
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance ApprovalCard with destructive styling, expandable sections, bulk preview, and category colors</name>
  <files>
    apps/web/src/components/ApprovalCard.tsx
    apps/web/src/pages/ChatPage.tsx
  </files>
  <action>
Enhance the existing ApprovalCard component with the following features. All changes are additive -- do not break existing state-based rendering (proposed, executing, succeeded, failed, declined).

**1. Category-based color differentiation (per user decision):**
- Read `proposal.category` (type ActionCategory from shared). If undefined, default to "internal".
- Linear actions (category === "linear"): Use the existing blue accent (rgba(33, 150, 243, *)) -- no change needed for these.
- OKR actions (category === "okr"): Use a teal/green accent (rgba(0, 150, 136, *)) -- subtly different from Linear blue. Apply to border, icon color, and action type label.
- Internal actions: Use the default blue.
- Add a small category badge/label at the top-left of the card: "Linear" in blue or "OKR" in teal, styled as a tiny chip (MUI Chip size="small" with appropriate color). Use a distinguishing icon: Linear actions get a small issue-like icon (e.g., Assignment or ConfirmationNumber), OKR actions get a flag or target icon (e.g., Flag or TrackChanges).

**2. Destructive action warning styling (per user decision):**
- Detect destructive actions: check if toolName is "delete_issue" or "delete_okr" (or more generically, check if the proposal description starts with "Delete"). A cleaner approach: store the destructive flag in the proposal or derive from toolName. Since we added destructive to ToolMetadata on the server, the simplest client approach is to check toolName against a known list: ["delete_issue", "delete_okr"].
- For destructive actions in "proposed" state:
  - Border color: rgba(244, 67, 54, 0.3) (red)
  - Background: rgba(244, 67, 54, 0.04) (very subtle red)
  - Add a WarningAmber icon next to the description in orange/red
  - Approve button: red variant (color="error") instead of primary blue
  - Add small text under description: "This action cannot be undone."

**3. Essential vs expandable fields for create actions (per user decision):**
- For create_issue and create_okr tools: categorize preview fields into essential and secondary.
- Essential fields for create_issue: Title, Priority, Assignee (always visible).
- Essential fields for create_okr: Objective, Quarter, Owner (always visible).
- Secondary fields: Description, Labels, Project, Key Results, etc.
- Render essential fields normally (as existing preview rows).
- If secondary fields exist, render them inside a collapsible section with an "Show more details" / "Show less" toggle (use MUI Collapse + a text button). Default to collapsed.
- For other tools (update, comment, etc.): show all fields normally (no expand/collapse).

**4. Bulk operation table preview (per user decision):**
- For bulk_update_issues tool: render the preview differently.
- Parse `proposal.toolArguments` to get issueIds array and updates object.
- Render a compact table-like layout:
  - Header row: "Issue | Changes"
  - One row per issue: show identifier (from issueIds) and a summary of what changes (e.g., "Priority: High, Assignee: Alice")
  - If more than 5 issues, show first 5 and a "+N more" expandable section
- If issueIds.length > 10, show a warning banner inside the card: "This will update {N} issues. Please review carefully." with amber background and WarningAmber icon.
- Use MUI Table or Box with grid layout to keep it clean.

**5. Identifier + title display (per user decision):**
- For update_issue, delete_issue, add_comment, manage_cycle, manage_labels tools: the description from the server already includes the identifier. But per user decision, also show the issue title.
- The approval card can look up the title from the proposal's toolArguments (which might have issueId as an identifier) or from the description.
- Simplest approach: the server's buildDescription already formats this. Just ensure the description is rendered prominently as the card title.
- If the description contains a colon (like "Update ENG-123: Set priority"), render the part before the colon in bold and the rest in regular weight.

**In ChatPage.tsx:**
- No significant changes needed since ChatPage already renders ApprovalCard with the full proposal object. The category field is already on ActionProposal (added in Plan 03's shared types). Just verify the proposal data flows through correctly.

**Implementation notes:**
- Keep the component file manageable. Extract sub-components (BulkPreviewTable, DestructiveWarning, CategoryBadge) as local components within the same file using simple function components above the main export.
- Use MUI's useTheme() for consistent color access if needed.
- Test both light references (the app uses dark theme per theme.ts, so ensure colors look good on dark background).
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/web/tsconfig.json` -- should compile cleanly. Visually inspect the component structure to confirm: category badge rendering, destructive styling conditions, expandable section for creates, bulk table layout, and identifier formatting.
  </verify>
  <done>
ApprovalCard enhanced with: (1) Category badges -- blue "Linear" chip vs teal "OKR" chip with distinct icons, (2) Red warning styling and "cannot be undone" text for destructive actions, (3) Essential fields visible with expandable "Show more" for secondary fields on creates, (4) Table-like layout for bulk operations with soft-cap warning above 10 issues, (5) Bold identifier formatting in descriptions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of all Phase 2 write actions</name>
  <files>none -- verification only</files>
  <action>
Human verification checkpoint. Start the development server (`npm run dev` or start server and web separately) and test the complete Phase 2 write action suite.

**Linear Issue Actions:**
1. In chat, ask: "Create a new issue called 'Test Phase 2 Write Actions' with high priority"
   - Verify: Approval card appears with blue "Linear" category badge
   - Verify: Preview shows Title, Priority as essential fields
   - Verify: Approve the action and confirm it creates the issue in Linear (check the result URL)

2. Ask: "Update that issue to assign it to [a team member name] and set it to In Progress"
   - Verify: Approval card shows multi-field update with both changes listed
   - Approve and verify the issue updates in Linear

3. Ask: "Add a comment to [issue identifier] saying 'This is a test comment from the AI agent'"
   - Verify: Approval card shows full comment text in preview
   - Approve and verify

4. Ask: "Delete issue [identifier]"
   - Verify: Approval card has RED/WARNING styling (red border, warning icon, "cannot be undone" text)
   - Verify: Approve button is red
   - Decline this one (do not actually delete)

**Bulk Operations:**
5. Ask: "Set priority to Medium for [2-3 issue identifiers]"
   - Verify: Single approval card with table-like preview showing each issue
   - Verify: Approve and confirm all issues updated

**OKR Actions:**
6. Ask: "Create an OKR: 'Improve developer experience' for Q1 2026, owned by [name], with key results: 'Reduce build time to under 2 minutes (target: 2, unit: minutes)' and 'Achieve 80% test coverage (target: 80, unit: %)'"
   - Verify: Approval card has teal "OKR" category badge (different from Linear blue)
   - Verify: Preview shows objective, quarter, owner, and key results
   - Approve and verify OKR appears in the OKR page

7. Ask: "Update the key result 'Reduce build time' to current value 3"
   - Verify: Approval card for update_key_result
   - Approve and verify progress updates

**Visual Checks:**
8. Confirm category badges: Linear actions show blue "Linear", OKR actions show teal "OKR"
9. Confirm expandable sections: create actions have "Show more details" for secondary fields
10. Confirm all approval card states work: proposed (full card), executing (spinner), succeeded (compact with link), failed, declined
  </action>
  <verify>Type "approved" if all checks pass, or describe any issues found.</verify>
  <done>Human has verified the full Phase 2 write action suite works end-to-end: Linear issue CRUD, bulk operations, OKR management, enhanced approval card rendering with category colors, destructive warnings, expandable sections, and bulk table preview.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles for both server and web: `npx tsc --noEmit -p apps/server/tsconfig.json && npx tsc --noEmit -p apps/web/tsconfig.json`
2. ApprovalCard renders category badges (Linear blue, OKR teal)
3. Destructive actions show red styling with warning text
4. Create actions have expandable sections for secondary fields
5. Bulk operations show table preview with soft-cap warning
6. End-to-end flow works: propose -> approve -> execute -> result for both Linear and OKR actions
</verification>

<success_criteria>
- User can create, update, delete issues and add comments through the chat approval flow, with changes reflected in Linear
- User can manage OKRs through the chat approval flow, with changes reflected in the app
- Approval cards are visually differentiated by action type (Linear vs OKR) and warn about destructive operations
- Bulk operations preview all changes in a table format with soft-cap warning
- Human verification confirms the full end-to-end flow works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/02-linear-internal-write-actions/02-04-SUMMARY.md`
</output>
