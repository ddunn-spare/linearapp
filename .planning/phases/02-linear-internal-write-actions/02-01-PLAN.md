---
phase: 02-linear-internal-write-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/server/src/adapters/linearGraphql.ts
  - apps/server/src/tools/index.ts
  - apps/server/src/services/approvalManager.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Agent can propose creating a Linear issue with title, description, priority, and assignee"
    - "Agent can propose updating issue fields (status, priority, assignee, labels, description) in a single action"
    - "Agent can propose deleting an issue with destructive action flagging"
    - "Agent can propose adding a comment to an issue showing full comment text"
    - "Approved create-issue action results in a real issue appearing in Linear"
    - "Approved update-issue action changes the specified fields in Linear"
  artifacts:
    - path: "apps/server/src/adapters/linearGraphql.ts"
      provides: "Linear GraphQL mutation methods"
      contains: "createIssue"
    - path: "apps/server/src/tools/index.ts"
      provides: "Core issue write tool definitions, metadata, and handlers"
      contains: "create_issue"
    - path: "apps/server/src/services/approvalManager.ts"
      provides: "Human-readable descriptions and result summaries for Linear issue tools"
      contains: "create_issue"
    - path: "packages/shared/src/index.ts"
      provides: "ActionCategory type for Linear vs OKR differentiation"
      contains: "ActionCategory"
  key_links:
    - from: "apps/server/src/tools/index.ts"
      to: "apps/server/src/adapters/linearGraphql.ts"
      via: "Tool handlers call linear adapter mutations"
      pattern: "linear\\.(createIssue|updateIssue|deleteIssue|addComment)"
    - from: "apps/server/src/services/approvalManager.ts"
      to: "apps/server/src/tools/index.ts"
      via: "buildDescription and buildResultSummary switch on tool names"
      pattern: "case \"(create_issue|update_issue|delete_issue|add_comment)\""
---

<objective>
Add Linear GraphQL mutation methods to the adapter and register four core issue write tools (create_issue, update_issue, delete_issue, add_comment) with full tool definitions, metadata, handlers, and preview generators. Replace the demo_create_issue tool.

Purpose: These are the foundational write tools that prove the approval flow works with real Linear mutations. Every subsequent tool follows this pattern.
Output: Four working write tools that create/update/delete issues and add comments via Linear API, all flowing through the existing approval infrastructure.
</objective>

<execution_context>
@/Users/devondunn/.claude/get-shit-done/workflows/execute-plan.md
@/Users/devondunn/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-approval-infrastructure-flow/01-02-SUMMARY.md

# Key source files to understand
@apps/server/src/tools/index.ts
@apps/server/src/adapters/linearGraphql.ts
@apps/server/src/services/approvalManager.ts
@packages/shared/src/index.ts
@apps/server/src/app.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Linear GraphQL mutation methods and shared types</name>
  <files>
    apps/server/src/adapters/linearGraphql.ts
    packages/shared/src/index.ts
  </files>
  <action>
Add the following mutation methods to LinearGraphqlClient in linearGraphql.ts:

1. `createIssue(params: { teamId: string; title: string; description?: string; priority?: number; assigneeId?: string; stateId?: string; labelIds?: string[]; projectId?: string; cycleId?: string }): Promise<{ id: string; identifier: string; url: string; title: string }>` -- Uses the `issueCreate` GraphQL mutation. The teamId is required by Linear. Return the created issue's id, identifier, url, and title.

2. `updateIssue(issueId: string, input: { title?: string; description?: string; priority?: number; assigneeId?: string; stateId?: string; labelIds?: string[]; projectId?: string; cycleId?: string }): Promise<{ success: boolean; issue?: { id: string; identifier: string; url: string } }>` -- Uses the `issueUpdate` mutation. Only send fields that are defined (not undefined) in the input object.

3. `deleteIssue(issueId: string): Promise<{ success: boolean }>` -- Uses the `issueDelete` mutation.

4. `addIssueComment(issueId: string, body: string): Promise<{ id: string; url?: string }>` -- Uses the `commentCreate` mutation with `issueId` and `body`. Return the comment id and the issue URL.

5. `getTeamId(teamKey: string): Promise<string>` -- Queries the team ID by team key. Cache the result in a private field since it won't change. This is needed because createIssue requires a team ID, not a team key.

6. `listProjects(teamKey: string): Promise<Array<{ id: string; name: string }>>` -- Lists projects for the team. Needed for assignable project lookup.

Each mutation method should follow the existing `query()` method pattern with proper error handling and type-safe response parsing. Use the same GraphQL query string format as existing methods.

In packages/shared/src/index.ts, add an `ActionCategory` type:
```typescript
export type ActionCategory = "linear" | "okr" | "internal";
```
This goes in the Action Proposals section. It will be used by the approval card to differentiate styling.

Also add it as an optional field to ActionProposal:
```typescript
category?: ActionCategory;
```
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/server/tsconfig.json` -- should compile with no errors. Verify the new methods exist by checking the file contains createIssue, updateIssue, deleteIssue, addIssueComment, getTeamId, and listProjects.
  </verify>
  <done>
LinearGraphqlClient has 6 new methods (createIssue, updateIssue, deleteIssue, addIssueComment, getTeamId, listProjects). ActionCategory type exists in shared package. All TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register core issue write tools and wire into approval manager</name>
  <files>
    apps/server/src/tools/index.ts
    apps/server/src/services/approvalManager.ts
    apps/server/src/app.ts
  </files>
  <action>
**In tools/index.ts:**

1. Update `createToolHandlers` to accept the LinearGraphqlClient as a parameter: `createToolHandlers(db: StateDb, linear: LinearGraphqlClient, cfg: AppConfig, trackedLinearIds?: Set<string>)`. The linear client and cfg are needed for mutation handlers to call Linear API and look up team/status IDs.

2. Remove `demo_create_issue` from toolMetadata and tool definitions (it was a Phase 1 demo placeholder).

3. Add four new tool definitions with `strict: true` and `additionalProperties: false`:

   **create_issue:**
   - Parameters: title (string, required), description (string|null), priority (number|null, enum [0,1,2,3,4,null]), assigneeName (string|null), labelNames (array of strings|null), projectName (string|null)
   - Note: Use human-readable names (assigneeName, labelNames, projectName) not IDs. The handler resolves names to IDs. This is per user decision: "agent infers reasonable defaults for fields the user didn't mention, shows them in the approval card."

   **update_issue:**
   - Parameters: issueId (string, required -- accepts identifier like "ENG-123"), title (string|null), description (string|null), priority (number|null), assigneeName (string|null), status (string|null -- status name like "In Progress"), labelNames (array of strings|null), projectName (string|null)
   - Note: Multi-field update in a single action per user decision.

   **delete_issue:**
   - Parameters: issueId (string, required)

   **add_comment:**
   - Parameters: issueId (string, required), body (string, required -- supports markdown per user decision)

4. Add toolMetadata entries for each:
   - `create_issue`: requiresApproval: true, category: "action", descriptionForUser: "Create a new issue in Linear", generatePreview that shows Title, Description (truncated to 100 chars), Priority (mapped to label), Assignee, Labels, Project -- only fields that have values.
   - `update_issue`: requiresApproval: true, category: "action", descriptionForUser: "Update an existing Linear issue", generatePreview that shows each changed field with old value placeholder (the handler won't know old values at preview time -- use "current" as oldValue placeholder; the approval manager buildDescription can enhance this).
   - `delete_issue`: requiresApproval: true, category: "action", descriptionForUser: "Delete a Linear issue permanently". Add a `destructive: true` field to the ToolMetadata type so the approval card can render warning styling per user decision.
   - `add_comment`: requiresApproval: true, category: "action", descriptionForUser: "Add a comment to a Linear issue", generatePreview that shows the full comment body (per user decision: "Comments show full text in the approval card").

5. Add `destructive?: boolean` to the ToolMetadata type. Also add `actionCategory?: "linear" | "okr" | "internal"` to ToolMetadata. Set actionCategory: "linear" for all four tools. Export a `getToolActionCategory` function.

6. Add tool handlers in createToolHandlers:

   **create_issue handler:**
   - Resolve assigneeName to assigneeId by searching db.getMembers() by name (case-insensitive partial match)
   - Resolve labelNames to labelIds via linear.listLabelsByName()
   - Resolve projectName to projectId by searching -- for now, add a listProjects query (already added in Task 1)
   - Get teamId via linear.getTeamId(cfg.linearTeamKey)
   - Call linear.createIssue() with resolved IDs
   - Return JSON: { success: true, issueId, identifier, title, url }

   **update_issue handler:**
   - Resolve issueId: if it looks like an identifier (contains "-"), search db.searchIssues to get the real UUID
   - Resolve names to IDs same as create
   - Resolve status name to stateId via db or linear.listStatuses
   - Call linear.updateIssue() with only defined fields
   - Return JSON: { success: true, issueId, identifier, url }

   **delete_issue handler:**
   - Resolve identifier to UUID if needed
   - Call linear.deleteIssue()
   - Return JSON: { success: true, identifier }

   **add_comment handler:**
   - Resolve identifier to UUID if needed
   - Call linear.addIssueComment()
   - Return JSON: { success: true, commentId, issueIdentifier, url }

**In approvalManager.ts:**

7. Update `buildDescription` with cases for create_issue, update_issue, delete_issue, add_comment:
   - create_issue: "Create issue: {title} ({Priority}, Assignee: {name})" -- include priority and assignee if provided
   - update_issue: "Update {identifier}: {field list}" -- list which fields are being changed
   - delete_issue: "Delete issue: {identifier}" -- keep it stark/clear for destructive action
   - add_comment: "Comment on {identifier}: {first 80 chars of body}..."

8. Update `buildResultSummary` with cases for each tool:
   - create_issue: "Created {identifier}: {title}" with URL
   - update_issue: "Updated {identifier}" with URL
   - delete_issue: "Deleted {identifier}"
   - add_comment: "Comment added to {identifier}"

9. Remove demo_create_issue cases from buildDescription and buildResultSummary.

**In app.ts:**

10. Update the createToolHandlers call to pass `linear` and `cfg`:
    ```typescript
    const toolHandlers = createToolHandlers(db, linear, cfg, trackedLinearIds);
    ```
    This requires updating the import and function signature.
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/server/tsconfig.json` -- should compile with no errors. Verify demo_create_issue no longer exists in tools/index.ts. Verify create_issue, update_issue, delete_issue, add_comment all appear in tool definitions, metadata, and handlers.
  </verify>
  <done>
Four core issue write tools registered with strict mode schemas, preview generators, and real Linear API handlers. Demo tool removed. ApprovalManager produces human-readable descriptions for each tool. App wiring updated to pass linear client and config to tool handlers.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p apps/server/tsconfig.json`
2. Tool definitions include create_issue, update_issue, delete_issue, add_comment
3. Tool metadata marks all four as requiresApproval: true with actionCategory: "linear"
4. delete_issue metadata has destructive: true
5. demo_create_issue no longer exists anywhere in tools/index.ts
6. linearGraphql.ts has createIssue, updateIssue, deleteIssue, addIssueComment, getTeamId, listProjects methods
7. approvalManager.ts has description and summary cases for all four tools
</verification>

<success_criteria>
- All four Linear issue write tools are fully functional: tool definition (OpenAI schema), metadata (preview, category, destructive flag), handler (resolves names to IDs, calls Linear API), and approval integration (description, result summary)
- The existing approval flow (propose -> approve -> execute) works with real Linear mutations
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-linear-internal-write-actions/02-01-SUMMARY.md`
</output>
